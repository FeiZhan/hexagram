/*! hexagram 31-10-2015 */
var HEXAGRAM=HEXAGRAM||{};HEXAGRAM.MagicCircle=function(a,b){this.selector=a,this.config=b||HEXAGRAM.MagicCircle.default_config,this.styles=HEXAGRAM.MagicCircle.default_config;var c,d,e,f,g=(2*Math.PI,this);this.id=Math.floor(1e7*Math.random()),this.draw={};var h=void 0;this.animationListeners=[],this.allElements=[],this.currentRadius=0,this.cast=function(b){this.draw;return h||(h=setInterval(g.animate,100)),f||this.init(),g.active=!0,g.caster={selector:a,last:null,ring:function(a,b,d){var h=new HEXAGRAM.Circle(f,{radius:g.currentRadius,strokeWidth:a||1,height:e,width:c,magicCircle:g});return b&&this.space(b),g.allElements.push(h),a&&(g.currentRadius+=a),this.last=h,d&&this.space(d),this},getTextFitSize:function(a){var b=10,h=new HEXAGRAM.RuneRing(f,{defs:d,height:e,width:c,magicCircle:g,radius:g.currentRadius,text:a,fontSize:b,speed:0,reverse:"0",leading:void 0}),i=h.getLength(),j=this.getCircumference(),k=j/i,l=b*k;return h.disperse(),l},getCircumference:function(){return 2*g.currentRadius*Math.PI},target:function(a){return this.last=a,this},color:function(a){return this.last.recolor?this.last.recolor(a):console.warn("Cant recolor this element",this.last),this},getLast:function(){return this.last},fill:function(a){return this.last.fill?this.last.fill(a):console.warn("Cant fill this element",this.last),this},rotation:function(a){return this.last.rotation?this.last.rotation(a):console.warn("Cant rotate element",this.last),this},circleRing:function(a,b,d,h){var i=new HEXAGRAM.CircleRing(f,{parent:g,height:e,width:c,radius:g.currentRadius+b,count:a,innerRadius:b,speed:d,reverse:h});return g.allElements.push(i),g.currentRadius+=2*b,this.last=i,this},space:function(a){return g.currentRadius+=a,this},backspace:function(a){return g.currentRadius-=a,this},text:function(a,b,h,i,j){if("autofit"==a){this.getCircumference();a=this.getTextFitSize(b),j="0"}var k=2,b=new HEXAGRAM.RuneRing(f,{defs:d,height:e,width:c,magicCircle:g,radius:g.currentRadius+k,text:b,fontSize:a,speed:h||1,reverse:i,leading:j});return g.allElements.push(b),g.currentRadius+=a,this.last=b,this},disperse:function(){g.disperse()},on:function(a,b){var c=this.last,d=this;return this.last.on?this.last.on(a,function(){d.last=c,b(d,c)}):console.warn("Can't attach a listener to this object"),this}},g.caster},this.init=function(){c=$(this.selector).width(),e=$(this.selector).height(),f=d3.select(this.selector).append("svg").attr("width",c).attr("height",e).attr("class","main").attr("shape-rendering","optimizeSpeed"),d=f.append("defs");var a=d.append("filter").attr("id","drop-blur"+this.id).attr("height","130%");a.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",this.styles.graphics.blur.level),a.append("feOffset").attr("in","blur").attr("dx",0).attr("dy",0).attr("result","offsetBlur");var b=a.append("feMerge");b.append("feMergeNode").attr("in","offsetBlur"),b.append("feMergeNode").attr("in","SourceGraphic");var g=d.append("filter").attr("id","drop-shadow"+this.id).attr("height","130%");g.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",this.styles.graphics.shadow.level).attr("result","blur"),g.append("feOffset").attr("in","blur").attr("dx",this.styles.graphics.shadow.distance).attr("dy",this.styles.graphics.shadow.distance).attr("result","offsetBlur"),g.append("feComponentTransfer").append("feFuncA").attr("type","linear").attr("slope","0.2");var h=g.append("feMerge");h.append("feMergeNode").attr("in","offsetBlur").attr("alpha","0.1"),h.append("feMergeNode").attr("in","SourceGraphic")},this.animate=function(){for(var a=0;a<g.animationListeners.length;a++)g.animationListeners[a]()},this.disperse=function(){g.active=!1;var a=(g.allElements.length,0);_.each(g.allElements,function(b){b.disperse().then(function(b){a++,b.remove()})}),g.allElements=[],g.animationListeners=[],clearInterval(h),h=null,g.currentRadius=0,g.caster=null}},HEXAGRAM.MagicCircle.default_config={colors:{ring:"#182645",text:"#243a6c",smallRing:"#304f93"},type:{leading:6,typecase:"uppercase"},animation:{inSpeed:666,animationSpeed:6.66},graphics:{blur:{level:0},shadow:{level:1,distance:0}}},HEXAGRAM.MagicCircle.prototype.onanimate=function(a){return this.animationListeners.push(a),{stop:function(){this.animationListeners=_.without(this.animationListeners,a)},start:function(){this.animationListeners.push(a)}}},HEXAGRAM.CircleRing=function(a,b){for(var c=2*Math.PI,d=0,e=a.append("g").attr("opacity",1),f=[],g=0;g<b.count;g++){var h=g/b.count,i=1,j=e.append("circle");j.attr("r",0).attr("cx",b.width/2+Math.cos((d+h)*c)*i*b.radius).attr("cy",b.height/2+Math.sin((d+h)*c)*i*b.radius).attr("stroke",b.parent.styles.colors.smallRing).attr("fill","none").attr("stroke-width",.5+b.innerRadius/15);var k=j.transition().duration(b.parent.styles.animation.inSpeed).attr("r",b.innerRadius).each("end",function(){j.t=void 0});j.t=k,f.push(j)}var l=b.parent.onanimate(function(){d=b.reverse?d-1*(b.speed||b.parent.styles.animation.animationSpeed):d+1*(b.speed||b.parent.styles.animation.animationSpeed),e.transition().ease("linear").duration(100).attr("transform","rotate("+d+", "+b.width/2+", "+b.height/2+")")});return{ref:e,recolor:function(a){_.each(f,function(b){b.attr("stroke",a)})},fill:function(a){_.each(f,function(b){b.attr("fill",a)})},disperse:function(){var a=Q.defer();l.stop(),_.each(f,function(a){a.transition().duration(500).attr("r",0)});var c=e.transition();return c.duration(b.parent.styles.animation.inSpeed).attr("opacity",0).each("end",a.resolve,e),a.promise}}},HEXAGRAM.Circle=function(a,b){var c=b.radius,d=b.strokeWidth,e=b.height,f=b.width,g=b.magicCircle,h=a.append("circle");h.attr("r",0).attr("cx",f/2).attr("cy",e/2).attr("opacity",1).attr("stroke",g.styles.colors.ring).attr("fill","none").style("filter","url(#drop-shadow"+g.id+")").attr("stroke-width",d||c/100),d>5&&h.style("filter","none");var i=h.transition().duration(g.styles.animation.inSpeed).attr("r",c+d/2).each("end",function(){i=null});return{ref:h,recolor:function(a){return i=i||h.transition(),"useNone"==a?void i.attr("stroke","rgba(0,0,0,0)").attr("fill-opacity","0.0"):void i.attr("stroke",a)},on:function(a,b){h.on(a,b)},disperse:function(){var a=Q.defer();return h.transition().duration(g.styles.animation.inSpeed).attr("opacity",0).attr("r",0).each("end",a.resolve,h),a.promise}}},HEXAGRAM.RuneRing=function(a,b){var c=b.defs,d=b.height,e=b.width,f=b.magicCircle,g=b.radius,h=b.text,i=b.fontSize,j=b.speed,k=b.reverse,l=b.leading,m=0,n=f.id+Math.floor(1e6*Math.random()),o=g,p=-o,q=0,r=c.append("path");r.attr("id","s3"+n).attr("d","m "+p+", "+q+" a -"+o+",-"+o+" 1 1,1 "+2*o+",0 a -"+o+",-"+o+" 1 1,1 -"+2*o+",0");var s=f.onanimate(function(){m=k?m-1*(j||f.styles.animation.animationSpeed):m+1*(j||f.styles.animation.animationSpeed),t.transition().duration(100).ease("linear").attr("transform","translate("+e/2+","+d/2+")  rotate("+m+")")}),t=a.append("g").attr("id","ring"+n).attr("transform","translate("+e/2+","+d/2+")  rotate("+m+")").style("pointer-events","none"),u=t.append("text").style("font-size",i+"px").attr("xlink:href","#s3"+n).style("text-transform",f.styles.type.typecase).style("filter","url(#drop-shadow"+f.id+")").text(h),v=t.select("text").node().getComputedTextLength();u.remove();var h=t.append("text").append("textPath").style("font-size",i+"px").attr("xlink:href","#s3"+n).style("letter-spacing",l||f.styles.type.leading).style("text-transform",f.styles.type.typecase).style("pointer-events","none").style("filter","url(#drop-shadow"+f.id+")").text(h).attr("fill",f.styles.colors.text).attr("opacity",0),w=h.transition().duration(f.styles.animation.inSpeed).ease("linear").attr("opacity",1).each("end",function(){w=null});return{ref:t,rotation:function(a){s.stop(),t.transition().attr("transform","translate("+e/2+","+d/2+")  rotate("+parseFloat(a+50)+")")},animate:function(){s.start()},getLength:function(){return v},recolor:function(a){w=w||h.transition(),w.attr("fill",a)},disperse:function(){var a=Q.defer();return w=h.transition(),w.attr("opacity",0).each("end",a.resolve,h),setTimeout(function(){t.remove(),h.remove()},500),a.promise}}};var MagicCircle=HEXAGRAM.MagicCircle;