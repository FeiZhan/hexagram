/*! hexagram 31-10-2015 */
var HEXAGRAM=HEXAGRAM||{};HEXAGRAM.Animation=function(a){this.config=a||{interval:100},this.callback_list=[],this.timer=void 0,this.status="init"},HEXAGRAM.Animation.prototype.run=function(){var a=this;this.timer=setInterval(function(){for(var b=0;b<a.callback_list.length;++b)a.callback_list[b]()},a.config.interval),this.status="running"},HEXAGRAM.Animation.prototype.pause=function(){this.status="paused"},HEXAGRAM.Animation.prototype.clear=function(){this.callback_list=[],clearInterval(this.timer),this.timer=void 0,this.status="stopped"},HEXAGRAM.Animation.prototype.add=function(a){this.callback_list.push(a)},HEXAGRAM.Animation.prototype.remove=function(a){this.callback_list.splice(this.callback_list.indexOf(a),1)};var HEXAGRAM=HEXAGRAM||{};HEXAGRAM.Ring=function(a,b){var c=b.parent,d=a.append("circle");d.attr("r",0).attr("cx",c.width/2).attr("cy",c.height/2).attr("opacity",1).attr("stroke",c.styles.colors.ring).attr("fill","none").style("filter","url(#drop-shadow"+c.id+")").attr("stroke-width",b.strokeWidth||b.radius/100),b.strokeWidth>5&&d.style("filter","none");var e=d.transition().duration(c.styles.animation.inSpeed).attr("r",b.radius+b.strokeWidth/2).each("end",function(){e=null});return b.strokeWidth&&(c.currentRadius+=b.strokeWidth),{ref:d,recolor:function(a){return e=e||d.transition(),"useNone"==a?void e.attr("stroke","rgba(0,0,0,0)").attr("fill-opacity","0.0"):void e.attr("stroke",a)},on:function(a,b){d.on(a,b)},disperse:function(){var a=Q.defer();return d.transition().duration(c.styles.animation.inSpeed).attr("opacity",0).attr("r",0).each("end",a.resolve,d),a.promise}}};var HEXAGRAM=HEXAGRAM||{};HEXAGRAM.CircleRing=function(a,b){for(var c=2*Math.PI,d=0,e=a.append("g").attr("opacity",1),f=[],g=0;g<b.count;++g){var h=g/b.count,i=1,j=e.append("circle");j.attr("r",0).attr("cx",b.width/2+Math.cos((d+h)*c)*i*b.radius).attr("cy",b.height/2+Math.sin((d+h)*c)*i*b.radius).attr("stroke",b.parent.styles.colors.smallRing).attr("fill","none").attr("stroke-width",.5+b.innerRadius/15);var k=j.transition().duration(b.parent.styles.animation.inSpeed).attr("r",b.innerRadius).each("end",function(){j.t=void 0});j.t=k,f.push(j)}var l=function(){d=b.reverse?d-1*(b.speed||b.parent.styles.animation.animationSpeed):d+1*(b.speed||b.parent.styles.animation.animationSpeed),e.transition().ease("linear").duration(100).attr("transform","rotate("+d+", "+b.width/2+", "+b.height/2+")")};return b.parent.animation.add(l),{ref:e,recolor:function(a){$.each(f,function(b,c){c.attr("stroke",a)})},fill:function(a){$.each(f,function(b,c){c.attr("fill",a)})},disperse:function(){var a=Q.defer();b.parent.animation.remove(l),$.each(f,function(a,b){b.transition().duration(500).attr("r",0)});var c=e.transition();return c.duration(b.parent.styles.animation.inSpeed).attr("opacity",0).each("end",a.resolve,e),a.promise}}};var HEXAGRAM=HEXAGRAM||{};HEXAGRAM.MagicCircle=function(a,b){this.selector=a,this.config=b||HEXAGRAM.MagicCircle.DefaultConfig,this.styles=HEXAGRAM.MagicCircle.DefaultConfig,this.id=Math.floor(1e7*Math.random()),this.height=0,this.width=0,this.defs={},this.canvas=void 0,this.animation=new HEXAGRAM.Animation,this.elements=[],this.current=void 0,this.currentRadius=0,this.init()},HEXAGRAM.MagicCircle.DefaultConfig={colors:{ring:"#182645",text:"#243a6c",smallRing:"#304f93"},type:{leading:6,typecase:"uppercase"},animation:{inSpeed:666,animationSpeed:6.66},graphics:{blur:{level:0},shadow:{level:1,distance:0}}},HEXAGRAM.MagicCircle.prototype.cast=function(){return this.run()},HEXAGRAM.MagicCircle.prototype.init=function(){this.width=$(this.selector).width(),this.height=$(this.selector).height(),this.canvas=d3.select(this.selector).append("svg").attr("width",this.width).attr("height",this.height).attr("class","main").attr("shape-rendering","optimizeSpeed"),this.defs=this.canvas.append("defs");var a=this.defs.append("filter").attr("id","drop-blur"+this.id).attr("height","130%");a.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",this.styles.graphics.blur.level),a.append("feOffset").attr("in","blur").attr("dx",0).attr("dy",0).attr("result","offsetBlur");var b=a.append("feMerge");b.append("feMergeNode").attr("in","offsetBlur"),b.append("feMergeNode").attr("in","SourceGraphic");var c=this.defs.append("filter").attr("id","drop-shadow"+this.id).attr("height","130%");c.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",this.styles.graphics.shadow.level).attr("result","blur"),c.append("feOffset").attr("in","blur").attr("dx",this.styles.graphics.shadow.distance).attr("dy",this.styles.graphics.shadow.distance).attr("result","offsetBlur"),c.append("feComponentTransfer").append("feFuncA").attr("type","linear").attr("slope","0.2");var d=c.append("feMerge");d.append("feMergeNode").attr("in","offsetBlur").attr("alpha","0.1"),d.append("feMergeNode").attr("in","SourceGraphic")},HEXAGRAM.MagicCircle.prototype.run=function(){return this.animation&&"running"==this.animation.status||this.animation.run(),this},HEXAGRAM.MagicCircle.prototype.add=function(a,b){switch(a){case"Ring":return this.addCircle(b);case"CircleRing":return this.addCircleRing(b);case"Text":return this.addText(b);default:this.elements.push(a),this.current=a}return this},HEXAGRAM.MagicCircle.prototype.addCircle=function(a){var b=this,c=new HEXAGRAM.Ring(b.canvas,{parent:b,radius:b.currentRadius,strokeWidth:a.strokeWidth||1});return a.spaceBefore&&this.space(a.spaceBefore),b.elements.push(c),this.current=c,a.spaceAfter&&this.space(a.spaceAfter),this.caster},HEXAGRAM.MagicCircle.prototype.addCircleRing=function(a){var b=this,c=new HEXAGRAM.CircleRing(b.canvas,{parent:b,height:b.height,width:b.width,radius:b.currentRadius+a.innerRadius,count:a.count,innerRadius:a.innerRadius,speed:a.speed,reverse:a.reverse});return b.elements.push(c),b.currentRadius+=2*a.innerRadius,this.current=c,this.caster},HEXAGRAM.MagicCircle.prototype.addText=function(a){var b=this;if("autofit"==a.my_height){2*b.currentRadius*Math.PI;a.my_height=this.getTextFitSize(a.text),a.leading="0"}var c=2,d=new HEXAGRAM.TextRing(b.canvas,{parent:b,radius:b.currentRadius+c,text:a.text,fontSize:a.my_height,speed:a.speed||1,reverse:a.reverse,leading:a.leading});return b.elements.push(d),b.currentRadius+=a.my_height,this.current=d,this.caster},HEXAGRAM.MagicCircle.prototype.getTextFitSize=function(a){var b=this,c=10,d=new HEXAGRAM.TextRing(b.canvas,{parent:b,radius:b.currentRadius,text:a,fontSize:c,speed:0,reverse:"0",leading:void 0}),e=d.getLength(),f=2*b.currentRadius*Math.PI,g=f/e,h=c*g;return d.disperse(),h},HEXAGRAM.MagicCircle.prototype.target=function(a){return this.current=a,this.current},HEXAGRAM.MagicCircle.prototype.getLast=function(){return this.current},HEXAGRAM.MagicCircle.prototype.color=function(a){return this.current.recolor?this.current.recolor(a):console.warn("Cant recolor this element",this.current),this},HEXAGRAM.MagicCircle.prototype.fill=function(a){return this.current.fill?this.current.fill(a):console.warn("Cant fill this element",this.current),this},HEXAGRAM.MagicCircle.prototype.rotation=function(a){return this.current.rotation?this.current.rotation(a):console.warn("Cant rotate element",this.current),this},HEXAGRAM.MagicCircle.prototype.on=function(a,b){var c=this.current,d=this;return this.current.on?this.current.on(a,function(){d.current=c,b(d,c)}):console.warn("Can't attach a listener to this object"),this},HEXAGRAM.MagicCircle.prototype.space=function(a){return this.currentRadius+=a,this},HEXAGRAM.MagicCircle.prototype.backspace=function(a){return this.currentRadius-=a,this},HEXAGRAM.MagicCircle.prototype.circleRing=function(a,b,c,d){return this.add("CircleRing",{count:a,innerRadius:b,speed:c,reverse:d}),this},HEXAGRAM.MagicCircle.prototype.ring=function(a,b,c){return this.add("Ring",{strokeWidth:a,spaceBefore:b,spaceAfter:c}),this},HEXAGRAM.MagicCircle.prototype.text=function(a,b,c,d,e){return this.add("Text",{my_height:a,text:b,speed:c,reverse:d,leading:e}),this},HEXAGRAM.MagicCircle.prototype.disperse=function(){var a=this;$.each(a.elements,function(a,b){b.disperse().then(function(a){a.remove()})}),a.animation.clear(),a.elements=[],a.currentRadius=0,a.caster=null};var MagicCircle=HEXAGRAM.MagicCircle,HEXAGRAM=HEXAGRAM||{};HEXAGRAM.TextRing=function(a,b){var c=b.parent,d=0,e=c.id+Math.floor(1e6*Math.random()),f=b.radius,g=-f,h=0,i=c.defs.append("path");i.attr("id","s3"+e).attr("d","m "+g+", "+h+" a -"+f+",-"+f+" 1 1,1 "+2*f+",0 a -"+f+",-"+f+" 1 1,1 -"+2*f+",0");var j=function(){d=b.reverse?d-1*(b.speed||c.styles.animation.animationSpeed):d+1*(b.speed||c.styles.animation.animationSpeed),k.transition().duration(100).ease("linear").attr("transform","translate("+c.width/2+","+c.height/2+")  rotate("+d+")")};c.animation.add(j);var k=a.append("g").attr("id","ring"+e).attr("transform","translate("+c.width/2+","+c.height/2+")  rotate("+d+")").style("pointer-events","none"),l=k.append("text").style("font-size",b.fontSize+"px").attr("xlink:href","#s3"+e).style("text-transform",c.styles.type.typecase).style("filter","url(#drop-shadow"+c.id+")").text(b.text),m=k.select("text").node().getComputedTextLength();l.remove();var n=k.append("text").append("textPath").style("font-size",b.fontSize+"px").attr("xlink:href","#s3"+e).style("letter-spacing",b.leading||c.styles.type.leading).style("text-transform",c.styles.type.typecase).style("pointer-events","none").style("filter","url(#drop-shadow"+c.id+")").text(b.text).attr("fill",c.styles.colors.text).attr("opacity",0),o=n.transition().duration(c.styles.animation.inSpeed).ease("linear").attr("opacity",1).each("end",function(){o=null});return{ref:k,rotation:function(a){b.parent.animation.remove(j),k.transition().attr("transform","translate("+c.width/2+","+c.height/2+")  rotate("+parseFloat(a+50)+")")},animate:function(){b.parent.animation.add(j)},getLength:function(){return m},recolor:function(a){o=o||n.transition(),o.attr("fill",a)},disperse:function(){var a=Q.defer();return o=n.transition(),o.attr("opacity",0).each("end",a.resolve,n),setTimeout(function(){k.remove(),n.remove()},500),a.promise}}};